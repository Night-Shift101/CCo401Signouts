import tkinter as tk
from tkinter import ttk, messagebox
import sys
import os

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))
from Config.colors import BG_PRIMARY, WHITE, GRAY_100, GRAY_200, GRAY_500, GRAY_600, GRAY_700, ONXY, SUCCESS, ERROR, PRIMARY_BLUE, PRIMARY_DARK
from Functions.pin_manager import PinManager

class PinAuthDialog:
    def __init__(self, parent=None, action_name="perform this action", default_ds=None):
        self.parent = parent
        self.action_name = action_name
        self.default_ds = default_ds
        self.pin_manager = PinManager()
        self.authenticated = False
        self.ds_name = None

        self.dialog = tk.Toplevel(parent) if parent else tk.Tk()
        self.dialog.title("Drill Sergeant Authentication")
        self.dialog.geometry("600x500")
        self.dialog.configure(bg=BG_PRIMARY)
        self.dialog.resizable(False, False)

        if parent:
            self.dialog.transient(parent)
            self.dialog.grab_set()

        self.center_dialog()

        self.create_ui()

        if self.default_ds and self.default_ds in self.pin_manager.list_ds_names():
            self.ds_var.set(self.default_ds)

            self.dialog.after(100, lambda: self.pin_entry.focus_set())
        else:
            self.ds_var.set("Select Drill Sergeant")
    
    def center_dialog(self):
        
        self.dialog.update_idletasks()
        
        if self.parent:

            parent_x = self.parent.winfo_rootx()
            parent_y = self.parent.winfo_rooty()
            parent_width = self.parent.winfo_width()
            parent_height = self.parent.winfo_height()
            
            x = parent_x + (parent_width // 2) - (600 // 2)
            y = parent_y + (parent_height // 2) - (500 // 2)
        else:

            screen_width = self.dialog.winfo_screenwidth()
            screen_height = self.dialog.winfo_screenheight()
            x = (screen_width // 2) - (600 // 2)
            y = (screen_height // 2) - (500 // 2)
        
        self.dialog.geometry(f"600x500+{x}+{y}")
    
    def create_ui(self):

        main_frame = tk.Frame(self.dialog, bg=BG_PRIMARY)
        main_frame.pack(fill=tk.BOTH, expand=True, padx=20, pady=20)

        content_frame = tk.Frame(main_frame, bg=WHITE)
        content_frame.pack(fill=tk.BOTH, expand=True)

        inner_frame = tk.Frame(content_frame, bg=WHITE)
        inner_frame.pack(fill=tk.BOTH, expand=True, padx=30, pady=30)

        title_label = tk.Label(
            inner_frame,
            text="DRILL SERGEANT\nAUTHENTICATION",
            bg=WHITE,
            fg=GRAY_700,
            font=("Arial", 16, "bold"),
            justify=tk.CENTER
        )
        title_label.pack(pady=(0, 10))

        action_label = tk.Label(
            inner_frame,
            text=f"Authentication required to {self.action_name}",
            bg=WHITE,
            fg=GRAY_600,
            font=("Arial", 11),
            justify=tk.CENTER,
            wraplength=300
        )
        action_label.pack(pady=(0, 20))

        ds_label = tk.Label(
            inner_frame,
            text="Drill Sergeant:",
            bg=WHITE,
            fg=GRAY_700,
            font=("Arial", 12, "bold"),
            anchor="w"
        )
        ds_label.pack(fill=tk.X, pady=(0, 5))

        ds_names = self.pin_manager.list_ds_names()
        self.ds_var = tk.StringVar()
        
        ds_combo = ttk.Combobox(
            inner_frame,
            textvariable=self.ds_var,
            values=ds_names,
            state="readonly",
            font=("Arial", 11),
            height=6
        )
        ds_combo.pack(fill=tk.X, pady=(0, 15))

        pin_label = tk.Label(
            inner_frame,
            text="PIN:",
            bg=WHITE,
            fg=GRAY_700,
            font=("Arial", 12, "bold"),
            anchor="w"
        )
        pin_label.pack(fill=tk.X, pady=(0, 5))
        
        self.pin_var = tk.StringVar()
        self.pin_entry = tk.Entry(
            inner_frame,
            textvariable=self.pin_var,
            font=("Arial", 14),
            show="*",  # Hide PIN characters
            bg=GRAY_100,
            fg=GRAY_700,
            relief="flat",
            bd=0,
            insertbackground=GRAY_700
        )
        self.pin_entry.pack(fill=tk.X, pady=(0, 20), ipady=8)

        self.pin_entry.bind("<Return>", lambda e: self.verify_pin())

        button_frame = tk.Frame(inner_frame, bg=WHITE)
        button_frame.pack(fill=tk.X, pady=(20, 0))

        # Cancel button - simple but styled
        cancel_btn = tk.Button(
            button_frame,
            text="Cancel",
            command=self.cancel,
            bg=GRAY_200,
            fg=GRAY_700,
            font=("Arial", 12, "bold"),
            relief="solid",
            bd=1,
            padx=30,
            pady=8,
            cursor="hand2"
        )
        cancel_btn.pack(side=tk.RIGHT, padx=(15, 0))

        # Verify button - simple but styled
        verify_btn = tk.Button(
            button_frame,
            text="Verify",
            command=self.verify_pin,
            bg=PRIMARY_BLUE,
            fg=WHITE,
            font=("Arial", 12, "bold"),
            relief="solid",
            bd=1,
            padx=30,
            pady=8,
            cursor="hand2"
        )
        verify_btn.pack(side=tk.RIGHT)

        def on_ds_select(event=None):
            self.pin_entry.focus_set()
        
        ds_combo.bind("<<ComboboxSelected>>", on_ds_select)
    
    def create_custom_buttons(self, parent):
        """Create custom rounded buttons that match the main application style"""
        
        # Cancel button frame
        cancel_frame = tk.Frame(parent, bg=WHITE, height=45)
        cancel_frame.pack(side=tk.RIGHT, padx=(15, 0))
        cancel_frame.pack_propagate(False)
        
        self.cancel_canvas = tk.Canvas(
            cancel_frame, 
            width=100, 
            height=45, 
            bg=WHITE, 
            highlightthickness=0
        )
        self.cancel_canvas.pack()
        
        # Verify button frame  
        verify_frame = tk.Frame(parent, bg=WHITE, height=45)
        verify_frame.pack(side=tk.RIGHT)
        verify_frame.pack_propagate(False)
        
        self.verify_canvas = tk.Canvas(
            verify_frame, 
            width=100, 
            height=45, 
            bg=WHITE, 
            highlightthickness=0
        )
        self.verify_canvas.pack()
        
        # Draw buttons after a short delay to ensure canvas is ready
        self.dialog.after(50, self.setup_buttons)
    
    def setup_buttons(self):
        """Setup button drawing and event handling after canvas is ready"""
        
        def draw_cancel_button(hover=False):
            self.cancel_canvas.delete("all")
            color = GRAY_100 if hover else GRAY_200
            radius = 12
            
            # Draw rounded rectangle for cancel button
            self.draw_rounded_rect(self.cancel_canvas, 2, 2, 98, 43, radius, color)
            
            # Draw text
            self.cancel_canvas.create_text(
                50, 22, 
                text="Cancel", 
                fill=GRAY_700, 
                font=("Arial", 12, "bold")
            )
        
        def draw_verify_button(hover=False):
            self.verify_canvas.delete("all")
            color = PRIMARY_DARK if hover else PRIMARY_BLUE
            radius = 12
            
            # Draw rounded rectangle for verify button
            self.draw_rounded_rect(self.verify_canvas, 2, 2, 98, 43, radius, color)
            
            # Draw text
            self.verify_canvas.create_text(
                50, 22, 
                text="Verify", 
                fill=WHITE, 
                font=("Arial", 12, "bold")
            )
        
        # Initial draw
        draw_cancel_button()
        draw_verify_button()
        
        # Bind events for cancel button
        self.cancel_canvas.bind("<Button-1>", lambda e: self.cancel())
        self.cancel_canvas.bind("<Enter>", lambda e: [self.cancel_canvas.configure(cursor="hand2"), draw_cancel_button(True)])
        self.cancel_canvas.bind("<Leave>", lambda e: [self.cancel_canvas.configure(cursor="arrow"), draw_cancel_button(False)])
        
        # Bind events for verify button
        self.verify_canvas.bind("<Button-1>", lambda e: self.verify_pin())
        self.verify_canvas.bind("<Enter>", lambda e: [self.verify_canvas.configure(cursor="hand2"), draw_verify_button(True)])
        self.verify_canvas.bind("<Leave>", lambda e: [self.verify_canvas.configure(cursor="arrow"), draw_verify_button(False)])

    def draw_rounded_rect(self, canvas, x1, y1, x2, y2, radius, fill_color):
        """Draw a rounded rectangle on the canvas"""
        # Top-left corner
        canvas.create_arc(x1, y1, x1 + 2*radius, y1 + 2*radius, 
                         start=90, extent=90, fill=fill_color, outline=fill_color)
        # Top-right corner
        canvas.create_arc(x2 - 2*radius, y1, x2, y1 + 2*radius, 
                         start=0, extent=90, fill=fill_color, outline=fill_color)
        # Bottom-left corner
        canvas.create_arc(x1, y2 - 2*radius, x1 + 2*radius, y2, 
                         start=180, extent=90, fill=fill_color, outline=fill_color)
        # Bottom-right corner
        canvas.create_arc(x2 - 2*radius, y2 - 2*radius, x2, y2, 
                         start=270, extent=90, fill=fill_color, outline=fill_color)
        
        # Fill rectangles to complete the rounded rectangle
        canvas.create_rectangle(x1 + radius, y1, x2 - radius, y2, 
                               fill=fill_color, outline=fill_color)
        canvas.create_rectangle(x1, y1 + radius, x2, y2 - radius, 
                               fill=fill_color, outline=fill_color)

    def verify_pin(self):
        
        ds_name = self.ds_var.get()
        pin = self.pin_var.get()

        if not ds_name or ds_name == "Select Drill Sergeant":
            messagebox.showerror("Error", "Please select a Drill Sergeant")
            return
        
        if not pin:
            messagebox.showerror("Error", "Please enter your PIN")
            return

        if self.pin_manager.verify_pin(ds_name, pin):
            self.authenticated = True
            self.ds_name = ds_name
            self.close()
        else:
            messagebox.showerror("Authentication Failed", "Invalid PIN. Please try again.")
            self.pin_var.set("")  # Clear PIN field
    
    def cancel(self):
        
        self.authenticated = False
        self.close()
    
    def close(self):
        
        if self.parent:
            self.dialog.grab_release()
        self.dialog.destroy()
    
    def show_and_wait(self):

        self.center_dialog()

        self.dialog.wait_window()
        
        return self.authenticated, self.ds_name

def test_pin_dialog():
    
    root = tk.Tk()
    root.withdraw()  # Hide main window
    
    dialog = PinAuthDialog(root, "edit a sign-out entry")
    authenticated, ds_name = dialog.show_and_wait()
    
    if authenticated:
        print(f"Authentication successful! DS: {ds_name}")
    else:
        print("Authentication cancelled or failed")
    
    root.destroy()

if __name__ == "__main__":
    test_pin_dialog()